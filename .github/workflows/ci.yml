name: CI

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      publish_nightly:
        type: boolean
        description: "Publish/overwrite the nightly release"
        default: false
  schedule:
    - cron: "0 6 * * *"

permissions:
  contents: write

env:
  FFMPEG_CONFIGURE_FLAGS: >-
    --enable-gpl
    --enable-liblz4
    --enable-libopus
    --enable-libvorbis
    --enable-libmp3lame
    --enable-libx264
    --enable-libx265
    --enable-libvpx
    --enable-libass
    --enable-libfreetype
    --enable-libfontconfig
    --enable-libfribidi
    --enable-libharfbuzz
    --enable-libxml2
    --enable-libzimg
    --enable-libwebp
    --enable-ffplay
    --enable-videotoolbox-remote
    --disable-debug

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      ffmpeg: ${{ steps.filter.outputs.ffmpeg }}
      vtremoted: ${{ steps.filter.outputs.vtremoted }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ffmpeg:
              - 'ffmpeg/**'
              - 'tests/integration/**'
            vtremoted:
              - 'vtremoted/**'
            docs:
              - 'docs/**'
              - 'README.md'
            ci:
              - '.github/workflows/ci.yml'

  swift-macos-arm64:
    name: Swift (vtremoted) macOS arm64
    needs: changes
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.publish_nightly) || startsWith(github.ref, 'refs/tags/') || needs.changes.outputs.vtremoted == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            vtremoted/.build
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/org.swift.swiftpm
          key: ${{ runner.os }}-swiftpm-${{ hashFiles('vtremoted/Package.swift', 'vtremoted/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swiftpm-
      - name: Install dependencies
        run: brew install lz4 pkg-config
      - name: Build vtremoted
        run: |
          cd vtremoted
          swift build -c release
      - name: Package vtremoted
        run: |
          mkdir -p dist/vtremoted
          cp vtremoted/.build/release/vtremoted dist/vtremoted/
          cp vtremoted/dist/README.md dist/vtremoted/README.md
          cp vtremoted/dist/install_launchd.sh dist/vtremoted/install_launchd.sh
          tar -C dist -czf vtremoted-macos-arm64.tar.gz vtremoted
          shasum -a 256 vtremoted-macos-arm64.tar.gz > vtremoted-macos-arm64.tar.gz.sha256
      - name: Upload vtremoted artifact
        uses: actions/upload-artifact@v4
        with:
          name: vtremoted-macos-arm64
          path: |
            vtremoted-macos-arm64.tar.gz
            vtremoted-macos-arm64.tar.gz.sha256

  ffmpeg-build:
    name: FFmpeg (${{ matrix.label }})
    needs: changes
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.publish_nightly) || startsWith(github.ref, 'refs/tags/') || needs.changes.outputs.ffmpeg == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: linux-x86_64
          - os: windows-latest
            label: windows-x86_64
          - os: macos-15-intel
            label: macos-x86_64
          - os: macos-14
            label: macos-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y yasm nasm pkg-config liblz4-dev ccache \
            libopus-dev libvorbis-dev libmp3lame-dev libx264-dev libx265-dev libvpx-dev \
            libass-dev libfreetype6-dev libfontconfig1-dev libfribidi-dev libharfbuzz-dev \
            libxml2-dev libzimg-dev libwebp-dev libsdl2-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install lz4 pkg-config yasm nasm ccache opus libvorbis lame x264 x265 libvpx libass freetype fontconfig fribidi harfbuzz libxml2 zimg webp sdl2

      - name: Install dependencies (Windows/MSYS2)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-lz4
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-ccache
            mingw-w64-x86_64-opus
            mingw-w64-x86_64-libvorbis
            mingw-w64-x86_64-lame
            mingw-w64-x86_64-x264
            mingw-w64-x86_64-x265
            mingw-w64-x86_64-libvpx
            mingw-w64-x86_64-libass
            mingw-w64-x86_64-freetype
            mingw-w64-x86_64-fontconfig
            mingw-w64-x86_64-fribidi
            mingw-w64-x86_64-harfbuzz
            mingw-w64-x86_64-libxml2
            mingw-w64-x86_64-zimg
            mingw-w64-x86_64-libwebp
            mingw-w64-x86_64-SDL2

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ matrix.label }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.label }}-

      - name: Configure + build (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          export CCACHE_DIR="${GITHUB_WORKSPACE}/.ccache"
          ccache -M 2G
          ccache -z
          if [ "${RUNNER_OS}" = "macOS" ]; then
            export CC="ccache clang"
            export CXX="ccache clang++"
            BREW_PKGS="lz4 opus libvorbis lame x264 x265 libvpx libass freetype fontconfig fribidi harfbuzz libxml2 zimg webp sdl2"
            for p in $BREW_PKGS; do
              prefix="$(brew --prefix "$p")"
              export PKG_CONFIG_PATH="${prefix}/lib/pkgconfig:${PKG_CONFIG_PATH}"
            done
            export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:${PKG_CONFIG_PATH}"
            export CPPFLAGS="-I$(brew --prefix)/include ${CPPFLAGS}"
            export LDFLAGS="-L$(brew --prefix)/lib ${LDFLAGS}"
          else
            export CC="ccache gcc"
            export CXX="ccache g++"
          fi
          cd ffmpeg
          ./configure $FFMPEG_CONFIGURE_FLAGS
          make -j2
          ccache -s
      - name: Package ffmpeg (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist
          cp ffmpeg/ffmpeg ffmpeg/ffprobe dist/
          if [ -f ffmpeg/ffplay ]; then
            cp ffmpeg/ffplay dist/
          fi
          tar -C dist -czf ffmpeg-${{ matrix.label }}.tar.gz .
          shasum -a 256 ffmpeg-${{ matrix.label }}.tar.gz > ffmpeg-${{ matrix.label }}.tar.gz.sha256

      - name: Configure + build (Windows/MSYS2)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          export CCACHE_DIR="${GITHUB_WORKSPACE}/.ccache"
          ccache -M 2G
          ccache -z
          export CC="ccache gcc"
          export CXX="ccache g++"
          cd ffmpeg
          ./configure $FFMPEG_CONFIGURE_FLAGS
          make -j2
          ccache -s
      - name: Package ffmpeg (Windows/MSYS2)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          mkdir -p dist
          cp ffmpeg/ffmpeg.exe ffmpeg/ffprobe.exe dist/
          if [ -f ffmpeg/ffplay.exe ]; then
            cp ffmpeg/ffplay.exe dist/
          fi
          tar -C dist -czf ffmpeg-${{ matrix.label }}.tar.gz .
          sha256sum ffmpeg-${{ matrix.label }}.tar.gz > ffmpeg-${{ matrix.label }}.tar.gz.sha256

      - name: Upload ffmpeg artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.label }}
          path: |
            ffmpeg-${{ matrix.label }}.tar.gz
            ffmpeg-${{ matrix.label }}.tar.gz.sha256

  publish-assets:
    name: Publish nightly / release assets
    runs-on: ubuntu-latest
    needs: [changes, swift-macos-arm64, ffmpeg-build]
    if: github.event_name != 'pull_request' && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.publish_nightly) || startsWith(github.ref, 'refs/tags/'))
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets
      - name: Flatten artifacts
        run: |
          mkdir -p release_flat
          find release_assets -type f -maxdepth 3 -print -exec cp {} release_flat/ \;
          cd release_flat
          sha256sum *.tar.gz > SHA256SUMS.txt
      - name: Publish nightly release
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.publish_nightly)
        uses: ncipollo/release-action@v1
        with:
          tag: nightly
          name: Nightly
          prerelease: true
          allowUpdates: true
          artifacts: "release_flat/*"
          artifactErrorsFailBuild: true
          makeLatest: false
          commit: ${{ github.sha }}
      - name: Publish tagged release
        if: startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "release_flat/*"
          artifactErrorsFailBuild: true
